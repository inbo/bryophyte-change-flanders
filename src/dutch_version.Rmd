---
title: "Nederlandstalige versie van figuren"
author: "Hans Van Calster, Wouter Van Landuyt"
date: "2023-08-29"
output:
  bookdown::html_document2:
    code_folding: "hide"
    toc: true
    toc_float: true
    self_contained: false
editor_options: 
  markdown: 
    wrap: sentence
---


```{r setup, include=FALSE}
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  dpi = 72,
  dev = "png",
  out.width = "100%")
opts_knit$set(root.dir = here())
library(brms)
library(ggplot2)
library(dplyr)
library(patchwork)
```

```{r}
options(contrasts = c("contr.sum", "contr.poly"))
model_zib_2 <- readRDS(here("output", "model_zib_2.rds"))
```


```{r}
create_conditions <- function(x, vars, ...) {
  vars <- rev(as.character(vars))
  if (!is.data.frame(x) && "data" %in% names(x)) {
    x <- x$data
  }
  x <- as.data.frame(x)
  out <- brms:::named_list(vars)
  for (v in vars) {
    tmp <- get(v, x)
    if (brms:::is_like_factor(tmp)) {
      tmp <- levels(as.factor(tmp))
    } else {
      tmp <- mean(tmp, na.rm = TRUE)
    }
    out[[v]] <- tmp
  }
  out <- rev(expand.grid(out))
  out$cond__ <- brms::rows2labels(out, ...)
  out
}
```

```{r conditions}
conditions0 <- create_conditions(
  x = model_zib_2,
  vars = c("n_square_1980_1999", "ell_f", "ell_n", "ell_l", "ell_t")) %>%
  mutate(phylum = NA,
         n_square_tot_2000_2019 = 227)

conditions1 <- create_conditions(
  x = model_zib_2,
  vars = c("ell_f", "ell_n", "ell_l", "ell_t")
) %>%
  mutate(phylum = NA,
         n_square_tot_2000_2019 = 227)

conditions2 <- create_conditions(
  x = model_zib_2,
  vars = c("n_square_1980_1999", "ell_f", "ell_l", "ell_t")
) %>%
  mutate(phylum = NA,
         n_square_tot_2000_2019 = 227)


conditions3 <- create_conditions(
  x = model_zib_2,
  vars = c("n_square_1980_1999", "ell_n", "ell_l", "ell_t")
) %>%
  mutate(phylum = NA,
         n_square_tot_2000_2019 = 227)

conditions4 <- create_conditions(
  x = model_zib_2,
  vars = c("n_square_1980_1999", "ell_n", "ell_f", "ell_t")
) %>%
  mutate(phylum = NA,
         n_square_tot_2000_2019 = 227)

conditions5 <- create_conditions(
  x = model_zib_2,
  vars = c("n_square_1980_1999", "ell_n", "ell_f", "ell_l")
) %>%
  mutate(phylum = NA,
         n_square_tot_2000_2019 = 227)

```

(ref:plot-epred) Estimated total number of occupied cells. The total number of grid cells in both periods equals 228. Expectations and 95% confidence bounds or intervals are given. These expectations are conditional on `r conditions0$cond__` for variables other than the one on the x-axis (held constant to mean value). The black point with 95% confidence ranges in (a) represents the overall effect conditional on all other variables and is the reference against which change is calculated in (b, c and d). Black lines: line of no change. (a) Change in recording probability. (b) Effect of substrate on occurrence of mosses. (c) Effect of Ellenberg nitrogen values on occurrence of mosses. (d) Effect of Ellenberg moisture values on occurrence of mosses.

The code chunk named `plot-epred` reproduces the figure from the paper.

Substrate random effects are calculated from the posterior linear predictor, conditional on Ellenberg values and the number of occupied grid cells fixed at their mean values.
@gelman2012 point out that no correction for multiple comparisons are necessary when substrate effects are calculated in this way.

```{r plot-epred, fig.cap='(ref:plot-epred)', fig.height = 220/25.4, warning=FALSE}
pep0 <- posterior_epred(model_zib_2,
                        re_formula = NA,
                        newdata = conditions0 %>%
                          mutate(substrate = NA,
                                 n_square_tot_2000_2019 = 227,
                                 n_square_tot_1980_1999 = 227
                          ))

pep0_conditions0 <- conditions0 %>%
  mutate(estimate__ = mean(pep0),
         lower__ = quantile(pep0, probs = 0.025),
         upper__  = quantile(pep0, probs = 0.975))

p1 <- conditional_effects(model_zib_2,
                          effects = "n_square_1980_1999",
                          conditions = conditions1)

p1 <- plot(p1, plot = FALSE, points = FALSE)[[1]] +
  geom_point(data = model_zib_2$data,
             aes(x = n_square_1980_1999 + 0.5,
                 y = n_square_2000_2019,
                 colour = phylum),
             alpha = 0.3,
             inherit.aes = FALSE) +
  geom_abline() +
  geom_pointrange(data = pep0_conditions0,
                  aes(x = n_square_1980_1999,
                      y = estimate__,
                      ymin = lower__,
                      ymax = upper__),
                  inherit.aes = FALSE) +
  labs(y = "Aantal bezette hokken\n(2000 - 2019)",
       x = "Aantal bezette hokken\n(1980 - 1999)") +
  theme(legend.title = element_blank())

dt <- function(x) x - pep0_conditions0$estimate__
idt <- function(x) x + pep0_conditions0$estimate__

p2 <- conditional_effects(model_zib_2,
                          effects = c("ell_n:phylum"),
                          conditions = conditions2)
p2[[1]] <- p2[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p2 <- plot(p2, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
               mutate(estimate__ = dt(estimate__)),
             aes(yintercept = estimate__),
             inherit.aes = FALSE) +
  scale_x_continuous(
    breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))
  ) +
  labs(y = "Verschil in aantal \nbezette hokken",
       x = "Ellenberg stikstofgetal") +
  theme(legend.position = "none")

p3 <- conditional_effects(model_zib_2,
                          effects = c("ell_f:phylum"),
                          conditions = conditions3)
p3[[1]] <- p3[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

# restrict range ell_f for Marchantiophyta to 4:11
p3$`ell_f:phylum` <- p3$`ell_f:phylum` %>%
  filter(!(phylum == "Marchantiophyta" &
             (ell_f < 4 | ell_f > 11)))

p3 <- plot(p3, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
               mutate(estimate__ = dt(estimate__)),
             aes(yintercept = estimate__),
             inherit.aes = FALSE) +
  scale_x_continuous(
    breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))
  ) +
  labs(y = "Verschil in aantal \nbezette hokken",
       x = "Ellenberg vochtgetal") +
  theme(legend.position = "none")


p4 <- conditional_effects(model_zib_2,
                          re_formula = NULL,
                          effects = c("substrate:phylum"),
                          conditions = conditions0)
p4[[1]] <- p4[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p4 <- p4$`substrate:phylum` %>%
  mutate(substrate = case_match(
           substrate,
           "artificial stone" ~ "steenslag",
           "bryophyte" ~ "andere mossen",
           "decaying vegetation" ~ "strooisel",
           "decorticated wood" ~ "ontschorst hout",
           "epiphytic on living wood" ~ "epifytisch op levend hout",
           "gravel or sand" ~ "grind of zand",
           "mineral soil" ~ "minerale bodem",
           "peat" ~ "veen",
           "rock, hard" ~ "hard gesteente",
           "rock, soft" ~ "zacht gesteente",
           "soil on rock" ~ "bodem op gesteente"
         ),
         substrate = reorder(substrate, estimate__)
         ) %>%
  ggplot() +
  geom_pointrange(aes(x = substrate, colour = phylum, y = estimate__,
                      ymin = lower__, ymax = upper__),
                  fatten = 2,
                  position = position_dodge(width = 0.5)) +
  geom_hline(data = pep0_conditions0 %>%
               mutate(estimate__ = dt(estimate__)),
             aes(yintercept = estimate__),
             inherit.aes = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x = element_blank(),
        legend.position = "none") +
  labs(y = "Verschil in aantal \nbezette hokken")

p5 <- conditional_effects(model_zib_2,
                          effects = c("ell_l:phylum"),
                          conditions = conditions4)
p5[[1]] <- p5[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p5 <- plot(p5, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
               mutate(estimate__ = dt(estimate__)),
             aes(yintercept = estimate__),
             inherit.aes = FALSE) +
  scale_x_continuous(
    breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))
  ) +
  labs(y = "Verschil in aantal \nbezette hokken",
       x = "Ellenberg lichtgetal") +
  theme(legend.position = "none")

p6 <- conditional_effects(model_zib_2,
                          effects = c("ell_t:phylum"),
                          conditions = conditions5)
p6[[1]] <- p6[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p6 <- plot(p6, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
               mutate(estimate__ = dt(estimate__)),
             aes(yintercept = estimate__),
             inherit.aes = FALSE) +
  scale_x_continuous(
    breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))
  ) +
  labs(y = "Verschil in aantal \nbezette hokken",
       x = "Ellenberg temperatuurgetal") +
  theme(legend.position = "none")


p1 + p4 + p2 + p3 + p5 + p6 +
  plot_layout(guides = "collect",
              ncol = 2,
              widths = c(1.1, 1)) +
  plot_annotation(tag_levels = "a") &
  theme(text = element_text(size = 9))
```

```{r}
p1
p2
p3
p4
p5
p6
```


